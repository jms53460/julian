Transfer tobacco DNA sequencing data onto the cluster and back it up
ssh jms53460@xfer.gacrc.uga.edu
cd /work/bnlab
mkdir AzentaDNASeq
cd AzentaDNASeq
sftp jms53460_uga@sftp.genewiz.com
#enter the password: 4VOFc2xnTVtsUVKkCvbN
get -r 30-1113073614

scp sapelo2:/work/bnlab/AzentaDNASeq/30-1113073614/00_fastq/*.fastq.gz 'D:\AzentaDNASeq'

mkdir /scratch/jms53460/Tobacco_DNAseq
cd /scratch/jms53460/Tobacco_DNAseq
mkdir Raw_Data

#!/bin/bash
#SBATCH --job-name=Copy_data                                                  # Job name
#SBATCH --partition=batch                                                     # Partition (queue) name
#SBATCH --ntasks=1                                                            # Single task job
#SBATCH --cpus-per-task=1                                                     # Number of cores per task
#SBATCH --mem=50gb                                                            # Total memory for job
#SBATCH --time=6:00:00                                                        # Time limit hrs:min:sec
#SBATCH --output=/scratch/jms53460/Tobacco_DNAseq/cp.out                      # Location of standard output file
#SBATCH --error=/scratch/jms53460/Tobacco_DNAseq/cp.err                       # Location of error log file
#SBATCH --mail-user=jms53460@uga.edu                                          # Where to send mail
#SBATCH --mail-type=END,FAIL                                                  # Mail events (BEGIN, END, FAIL, ALL)

cd /scratch/jms53460/Tobacco_DNAseq
cp /work/bnlab/AzentaDNASeq/30-1113073614/00_fastq/TW*.fastq.gz Raw_Data

#used nano to make text file and submit cp as bash script because cp was killed when I tried it in command line


###Copying tobacco genome and hisat2 index
cp /home/jms53460/Ns_genome.fna /scratch/jms53460/Tobacco_DNAseq
cp /home/jms53460/Ns_hisat2_index* /scratch/jms53460/Tobacco_DNAseq


#Add UMIs to headers and filter (fastp), map to genome (hisat2), .bam output (samtools view), sort (samtools sort)

#!/bin/bash
#SBATCH --job-name=Ns_fastp_hisat2                                    # Job name
#SBATCH --partition=batch                                             # Partition (queue) name
#SBATCH --ntasks=1                                                    # Single task job
#SBATCH --cpus-per-task=6                                             # Number of cores per task
#SBATCH --mem=50gb                                                    # Total memory for job
#SBATCH --time=12:00:00                                               # Time limit hrs:min:sec
#SBATCH --output=/scratch/jms53460/Tobacco_DNAseq/Ns_fh2.out          # Location of standard output file
#SBATCH --error=/scratch/jms53460/Tobacco_DNAseq/Ns_fh2.err           # Location of error log file
#SBATCH --mail-user=jms53460@uga.edu                                  # Where to send mail
#SBATCH --mail-type=END,FAIL                                          # Mail events (BEGIN, END, FAIL, ALL)

cd /scratch/jms53460/Tobacco_DNAseq
mkdir hisat2_out
for file in "Raw_Data/"*_R1_001.fastq.gz
do
	file2="${file:9:-16}"

if [ ! -f "hisat2_out/""$file2"".bam" ]; then

	module load fastp/0.23.2-GCC-11.3.0
	fastp -w 6 -i "$file" -I "Raw_Data/""$file2""_R2_001.fastq.gz" -o "hisat2_out/""$file2""_R1_001.fastq.gz" -O "hisat2_out/""$file2""_R2_001.fastq.gz"

    ml HISAT2/3n-20201216-gompi-2022a
	module load SAMtools/1.16.1-GCC-11.3.0
	hisat2 -p 6 --dta -x Ns_hisat2_index -1 "hisat2_out/""$file2""_R1_001.fastq.gz" -2 "hisat2_out/""$file2""_R2_001.fastq.gz" | samtools view -bS -> "hisat2_out/""$file2""_unsorted.bam"
	samtools sort -@ 6 "hisat2_out/""$file2""_unsorted.bam" -o "hisat2_out/""$file2""_s.bam"
	
fi
done


#!/bin/bash
#SBATCH --job-name=Ns_DNA_vcf                                      # Job name
#SBATCH --partition=batch                                          # Partition (queue) name
#SBATCH --ntasks=1                                                 # Single task job
#SBATCH --cpus-per-task=6                                          # Number of cores per task
#SBATCH --mem=50gb                                                 # Total memory for job
#SBATCH --time=12:00:00                                            # Time limit hrs:min:sec
#SBATCH --output=/scratch/jms53460/Tobacco_DNAseq/Ns_vcf.out          # Location of standard output file
#SBATCH --error=/scratch/jms53460/Tobacco_DNAseq/Ns_vcf.err           # Location of error log file
#SBATCH --mail-user=jms53460@uga.edu                               # Where to send mail
#SBATCH --mail-type=END,FAIL                                       # Mail events (BEGIN, END, FAIL, ALL)

cd /scratch/jms53460/Tobacco_DNAseq
module load SAMtools/1.16.1-GCC-11.3.0
samtools index -@ 6 hisat2_out/TW136_s.bam
samtools index -@ 6 hisat2_out/TW137_s.bam

module load BCFtools/1.15.1-GCC-11.3.0
bcftools mpileup -Ou --threads 6 -d 1000000 --min-MQ 60 -f Ns_genome.fna hisat2_out/TW136_s.bam | bcftools call -Ou -m -v --threads 6 | bcftools filter -Oz -e 'QUAL<40 || DP<10' > TW136.vcf.gz
bcftools index TW136.vcf.gz

bcftools mpileup -Ou --threads 6 -d 1000000 --min-MQ 60 -f Ns_genome.fna hisat2_out/TW137_s.bam | bcftools call -Ou -m -v --threads 6 | bcftools filter -Oz -e 'QUAL<40 || DP<10' > TW137.vcf.gz
bcftools index TW137.vcf.gz


#There was a similar number of variants in TW136.vcf.gz and TW137.vcf.gz, many of which seem to match looking at the beginning of the vcf files
#Make consensus sequence that incorporates TW136 variants into the reference. Then I'll make a new vcf by calling variants from TW137 on the consensus reference
#From bcf tools documentation: https://samtools.github.io/bcftools/howtos/consensus-sequence.html
# call variants
#bcftools mpileup -Ou -f reference.fa alignments.bam | bcftools call -mv -Oz -o calls.vcf.gz
#bcftools index calls.vcf.gz #did this already


#!/bin/bash
#SBATCH --job-name=Ns_DNA_vcf2                                      # Job name
#SBATCH --partition=batch                                          # Partition (queue) name
#SBATCH --ntasks=1                                                 # Single task job
#SBATCH --cpus-per-task=6                                          # Number of cores per task
#SBATCH --mem=100gb                                                 # Total memory for job
#SBATCH --time=24:00:00                                            # Time limit hrs:min:sec
#SBATCH --output=/scratch/jms53460/Tobacco_DNAseq/Ns_vcf2.out          # Location of standard output file
#SBATCH --error=/scratch/jms53460/Tobacco_DNAseq/Ns_vcf2.err           # Location of error log file
#SBATCH --mail-user=jms53460@uga.edu                               # Where to send mail
#SBATCH --mail-type=END,FAIL                                       # Mail events (BEGIN, END, FAIL, ALL)

cd /scratch/jms53460/Tobacco_DNAseq
module load BCFtools/1.15.1-GCC-11.3.0
# normalize indels
bcftools norm -f Ns_genome.fna TW136.vcf.gz -Ob -o TW136.norm.bcf 

# filter adjacent indels within 5bp
bcftools filter --IndelGap 5 TW136.norm.bcf -Ob -o TW136.norm.flt-indels.bcf

# apply variants to create consensus sequence
cat Ns_genome.fna | bcftools consensus TW136.vcf.gz > TW136_consensus.fa

# output IUPAC ambiguity codes based on REF+ALT columns (regardless of genotype)
cat Ns_genome.fna | bcftools consensus --iupac-codes TW136.vcf.gz > TW136_consensus.fa

# output IUPAC ambiguity codes based on sample genotypes
cat Ns_genome.fna | bcftools consensus --haplotype I TW136.vcf.gz > TW136_consensus.fa



#!/bin/bash
#SBATCH --job-name=Ns_hisat2_vcf                                      # Job name
#SBATCH --partition=batch                                             # Partition (queue) name
#SBATCH --ntasks=1                                                    # Single task job
#SBATCH --cpus-per-task=6                                             # Number of cores per task
#SBATCH --mem=50gb                                                    # Total memory for job
#SBATCH --time=12:00:00                                               # Time limit hrs:min:sec
#SBATCH --output=/scratch/jms53460/Tobacco_DNAseq/Ns_h2_vcf.out       # Location of standard output file
#SBATCH --error=/scratch/jms53460/Tobacco_DNAseq/Ns_h2_vcf.err        # Location of error log file
#SBATCH --mail-user=jms53460@uga.edu                                  # Where to send mail
#SBATCH --mail-type=END,FAIL                                          # Mail events (BEGIN, END, FAIL, ALL)

cd /scratch/jms53460/Tobacco_DNAseq
mkdir hisat2_out2
cp hisat2_out/*fastq.gz hisat2_out2
for file in "Raw_Data/"*_R1_001.fastq.gz
do
	file2="${file:9:-16}"

if [ ! -f "hisat2_out2/""$file2"".bam" ]; then

    ml HISAT2/3n-20201216-gompi-2022a
    hisat2-build TW136_consensus.fa TW136_consensus_index
	module load SAMtools/1.16.1-GCC-11.3.0
	hisat2 -p 6 --dta -x TW136_consensus_index -1 "hisat2_out2/""$file2""_R1_001.fastq.gz" -2 "hisat2_out2/""$file2""_R2_001.fastq.gz" | samtools view -bS -> "hisat2_out2/""$file2""_unsorted.bam"
	samtools sort -@ 6 "hisat2_out2/""$file2""_unsorted.bam" -o "hisat2_out2/""$file2""_s.bam"
	
fi
done

module load BCFtools/1.15.1-GCC-11.3.0
bcftools mpileup -Ou --threads 6 -d 1000000 --min-MQ 60 -f TW136_consensus.fa hisat2_out2/TW137_s.bam | bcftools call -Ou -m -v --threads 6 | bcftools filter -Oz -e 'QUAL<40 || DP<10' > TW137_consensus.vcf.gz
bcftools index TW137_consensus.vcf.gz
bcftools mpileup -Ou --threads 6 -d 1000000 --min-MQ 60 -f TW136_consensus.fa hisat2_out2/TW136_s.bam | bcftools call -Ou -m -v --threads 6 | bcftools filter -Oz -e 'QUAL<40 || DP<10' > TW136_consensus.vcf.gz
bcftools index TW136_consensus.vcf.gz





gzip -d TW137.vcf.gz


scp sapelo2:/scratch/jms53460/June2024Seq/NTD4-3.vcf .
scp sapelo2:/scratch/jms53460/June2024Seq/hisat2_out/umi_NTD4-3_S372_L006_R1_s.bam .
scp sapelo2:/scratch/jms53460/June2024Seq/hisat2_out/umi_NTD4-3_S372_L006_R1_s.bam.bai .


module load BCFtools/1.15.1-GCC-11.3.0
bcftools view -i 'GT="AA"' NTD4-3.vcf > NTD4-3_hom.vcf


scp sapelo2:/scratch/jms53460/June2024Seq/NTD4-3_hom.vcf .


gzip -d NTD3-3.vcf
gzip -d NTD5-4.vcf
module load BCFtools/1.15.1-GCC-11.3.0
bcftools view -i 'GT="AA"' NTD3-3.vcf > NTD3-3_hom.vcf
bcftools view -i 'GT="AA"' NTD5-4.vcf > NTD5-4_hom.vcf


scp sapelo2:/scratch/jms53460/June2024Seq/NTD3-3.vcf .
scp sapelo2:/scratch/jms53460/June2024Seq/NTD3-3_hom.vcf .
scp sapelo2:/scratch/jms53460/June2024Seq/hisat2_out/umi_NTD3-3*_s.bam* .

scp sapelo2:/scratch/jms53460/June2024Seq/NTD5-4.vcf .
scp sapelo2:/scratch/jms53460/June2024Seq/NTD5-4_hom.vcf .
scp sapelo2:/scratch/jms53460/June2024Seq/hisat2_out/umi_NTD5-4*_s.bam* .
